{"ast":null,"code":"import express from \"express\";\nimport cors from \"cors\";\nimport fetch from \"node-fetch\";\nimport { getGroqPrompt } from \"./prompt.js\";\nconst app = express();\napp.use(cors({\n  origin: \"http://localhost:3000\"\n}));\napp.use(express.json());\nconst PORT = 5000;\nconst GROQ_API_KEY = \"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\";\nconst PAPPERS_API_KEY = \"f5aa1a6b1a7811a5d74db7e59a32212506af8fbc079c79ca\";\nconst HUNTER_API_KEY = \"11aca442ea103c667ba92165848e9390219d5086\";\n\n// === 1. GROQ : Génère structure + contacts prioritaires ===\nasync function generateWithGroq(companyName, location) {\n  var _data$choices, _data$choices$, _data$choices$$messag;\n  const prompt = `${getGroqPrompt()}\\n\\n**Entreprise de référence :** ${companyName}\\n**Localisation :** ${location}`;\n  const res = await fetch(\"https://api.groq.com/openai/v1/chat/completions\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": `Bearer ${GROQ_API_KEY}`\n    },\n    body: JSON.stringify({\n      model: \"llama-3.1-8b-instant\",\n      messages: [{\n        role: \"user\",\n        content: prompt\n      }],\n      temperature: 0.2\n    })\n  });\n  const data = await res.json();\n  const content = ((_data$choices = data.choices) === null || _data$choices === void 0 ? void 0 : (_data$choices$ = _data$choices[0]) === null || _data$choices$ === void 0 ? void 0 : (_data$choices$$messag = _data$choices$.message) === null || _data$choices$$messag === void 0 ? void 0 : _data$choices$$messag.content) || \"\";\n  const jsonMatch = content.match(/\\[[\\s\\S]*\\]/);\n  if (!jsonMatch) throw new Error(\"Pas de JSON Groq\");\n  return JSON.parse(jsonMatch[0]);\n}\n\n// === 2. PAPPERS : Vérifie + enrichit avec données officielles ===\nasync function enrichWithPappers(groqData, location) {\n  const enriched = await Promise.all(groqData.map(async ent => {\n    var _data$resultats;\n    // Recherche par nom + CP\n    const url = `https://api.pappers.fr/v2/recherche?q=${encodeURIComponent(ent.nom)}&code_postal=${encodeURIComponent(location)}&api_token=${PAPPERS_API_KEY}`;\n    const res = await fetch(url);\n    const data = await res.json();\n    const match = (_data$resultats = data.resultats) === null || _data$resultats === void 0 ? void 0 : _data$resultats[0];\n\n    // Si trouvé → remplace par données officielles\n    if (match) {\n      const emails = match.site_web ? await getHunterEmails(match.site_web) : [];\n      return {\n        ...ent,\n        nom: match.nom_entreprise || ent.nom,\n        adresse: match.adresse_siege || ent.adresse,\n        secteur: match.libelle_naf || ent.secteur,\n        site_web: match.site_web || ent.site_web,\n        resume: `SIREN: ${match.siren} | ${match.effectif ? match.effectif + \" employés\" : \"\"} | ${ent.resume}`,\n        contacts: emails.length ? emails : ent.contacts,\n        sources: [...(ent.sources || []), \"Pappers.fr\", \"Hunter.io\"]\n      };\n    }\n    return ent; // Sinon garde Groq\n  }));\n  return enriched;\n}\nasync function getHunterEmails(domain) {\n  if (!domain) return [];\n  const clean = domain.replace(/^https?:\\/\\//, \"\").split(\"/\")[0];\n  const url = `https://api.hunter.io/v2/domain-search?domain=${clean}&api_key=${HUNTER_API_KEY}`;\n  try {\n    var _json$data;\n    const res = await fetch(url);\n    const json = await res.json();\n    return (((_json$data = json.data) === null || _json$data === void 0 ? void 0 : _json$data.emails) || []).slice(0, 3).map(e => ({\n      poste: e.position || \"Dirigeant\",\n      nom: `${e.first_name || \"\"} ${e.last_name || \"\"}`.trim() || \"Inconnu\",\n      email: e.value || \"\",\n      telephone: \"\",\n      linkedin: e.linkedin || \"\"\n    })).filter(c => c.email);\n  } catch {\n    return [];\n  }\n}\n\n// === ENDPOINT HYBRIDE ===\napp.post(\"/prospect\", async (req, res) => {\n  const {\n    companyName,\n    location\n  } = req.body;\n  if (!companyName || !location) return res.status(400).json({\n    error: \"Requis\"\n  });\n  try {\n    // 1. GROQ génère la liste\n    console.log(\"GROQ génère...\");\n    let data = await generateWithGroq(companyName, location);\n\n    // 2. PAPPERS enrichit\n    console.log(\"PAPPERS enrichit...\");\n    data = await enrichWithPappers(data, location);\n\n    // 3. Filtre : au moins 1 contact\n    data = data.filter(ent => ent.contacts.some(c => c.email || c.telephone));\n    res.json({\n      data\n    });\n  } catch (err) {\n    console.error(err);\n    res.status(500).json({\n      error: \"Erreur hybride\"\n    });\n  }\n});\napp.listen(PORT, () => console.log(`HYBRIDE → http://localhost:${PORT}`));","map":{"version":3,"names":["express","cors","fetch","getGroqPrompt","app","use","origin","json","PORT","GROQ_API_KEY","PAPPERS_API_KEY","HUNTER_API_KEY","generateWithGroq","companyName","location","_data$choices","_data$choices$","_data$choices$$messag","prompt","res","method","headers","body","JSON","stringify","model","messages","role","content","temperature","data","choices","message","jsonMatch","match","Error","parse","enrichWithPappers","groqData","enriched","Promise","all","map","ent","_data$resultats","url","encodeURIComponent","nom","resultats","emails","site_web","getHunterEmails","nom_entreprise","adresse","adresse_siege","secteur","libelle_naf","resume","siren","effectif","contacts","length","sources","domain","clean","replace","split","_json$data","slice","e","poste","position","first_name","last_name","trim","email","value","telephone","linkedin","filter","c","post","req","status","error","console","log","some","err","listen"],"sources":["/home/dehlia/prospection/tableau-entreprises/frontend/src/App.jsx"],"sourcesContent":["import express from \"express\";\nimport cors from \"cors\";\nimport fetch from \"node-fetch\";\nimport { getGroqPrompt } from \"./prompt.js\";\n\nconst app = express();\napp.use(cors({ origin: \"http://localhost:3000\" }));\napp.use(express.json());\n\nconst PORT = 5000;\nconst GROQ_API_KEY = \"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\";\nconst PAPPERS_API_KEY = \"f5aa1a6b1a7811a5d74db7e59a32212506af8fbc079c79ca\";\nconst HUNTER_API_KEY = \"11aca442ea103c667ba92165848e9390219d5086\";\n\n// === 1. GROQ : Génère structure + contacts prioritaires ===\nasync function generateWithGroq(companyName, location) {\n  const prompt = `${getGroqPrompt()}\\n\\n**Entreprise de référence :** ${companyName}\\n**Localisation :** ${location}`;\n  \n  const res = await fetch(\"https://api.groq.com/openai/v1/chat/completions\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": `Bearer ${GROQ_API_KEY}`,\n    },\n    body: JSON.stringify({\n      model: \"llama-3.1-8b-instant\",\n      messages: [{ role: \"user\", content: prompt }],\n      temperature: 0.2,\n    }),\n  });\n\n  const data = await res.json();\n  const content = data.choices?.[0]?.message?.content || \"\";\n  const jsonMatch = content.match(/\\[[\\s\\S]*\\]/);\n  if (!jsonMatch) throw new Error(\"Pas de JSON Groq\");\n\n  return JSON.parse(jsonMatch[0]);\n}\n\n// === 2. PAPPERS : Vérifie + enrichit avec données officielles ===\nasync function enrichWithPappers(groqData, location) {\n  const enriched = await Promise.all(\n    groqData.map(async (ent) => {\n      // Recherche par nom + CP\n      const url = `https://api.pappers.fr/v2/recherche?q=${encodeURIComponent(ent.nom)}&code_postal=${encodeURIComponent(location)}&api_token=${PAPPERS_API_KEY}`;\n      const res = await fetch(url);\n      const data = await res.json();\n      const match = data.resultats?.[0];\n\n      // Si trouvé → remplace par données officielles\n      if (match) {\n        const emails = match.site_web ? await getHunterEmails(match.site_web) : [];\n        return {\n          ...ent,\n          nom: match.nom_entreprise || ent.nom,\n          adresse: match.adresse_siege || ent.adresse,\n          secteur: match.libelle_naf || ent.secteur,\n          site_web: match.site_web || ent.site_web,\n          resume: `SIREN: ${match.siren} | ${match.effectif ? match.effectif + \" employés\" : \"\"} | ${ent.resume}`,\n          contacts: emails.length ? emails : ent.contacts,\n          sources: [...(ent.sources || []), \"Pappers.fr\", \"Hunter.io\"],\n        };\n      }\n      return ent; // Sinon garde Groq\n    })\n  );\n  return enriched;\n}\n\nasync function getHunterEmails(domain) {\n  if (!domain) return [];\n  const clean = domain.replace(/^https?:\\/\\//, \"\").split(\"/\")[0];\n  const url = `https://api.hunter.io/v2/domain-search?domain=${clean}&api_key=${HUNTER_API_KEY}`;\n  try {\n    const res = await fetch(url);\n    const json = await res.json();\n    return (json.data?.emails || []).slice(0, 3).map(e => ({\n      poste: e.position || \"Dirigeant\",\n      nom: `${e.first_name || \"\"} ${e.last_name || \"\"}`.trim() || \"Inconnu\",\n      email: e.value || \"\",\n      telephone: \"\",\n      linkedin: e.linkedin || \"\",\n    })).filter(c => c.email);\n  } catch {\n    return [];\n  }\n}\n\n// === ENDPOINT HYBRIDE ===\napp.post(\"/prospect\", async (req, res) => {\n  const { companyName, location } = req.body;\n  if (!companyName || !location) return res.status(400).json({ error: \"Requis\" });\n\n  try {\n    // 1. GROQ génère la liste\n    console.log(\"GROQ génère...\");\n    let data = await generateWithGroq(companyName, location);\n\n    // 2. PAPPERS enrichit\n    console.log(\"PAPPERS enrichit...\");\n    data = await enrichWithPappers(data, location);\n\n    // 3. Filtre : au moins 1 contact\n    data = data.filter(ent => ent.contacts.some(c => c.email || c.telephone));\n\n    res.json({ data });\n  } catch (err) {\n    console.error(err);\n    res.status(500).json({ error: \"Erreur hybride\" });\n  }\n});\n\napp.listen(PORT, () => console.log(`HYBRIDE → http://localhost:${PORT}`));"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}